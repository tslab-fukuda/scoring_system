{% extends "base.html" %}
{% load static %}

{% block title %}ãƒ¦ãƒ¼ã‚¶ä¸€è¦§{% endblock %}

{% block content %}
<div id="user-table" class="p-4">
    <h2>ãƒ¦ãƒ¼ã‚¶ä¸€è¦§</h2>
    <button class="btn btn-primary mb-3" @click="showModal = true">ï¼‹ æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</button>

    <!-- æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div v-if="showModal" class="ts-modal-overlay">
        <div class="ts-modal">
            <h3>æ–°è¦ãƒ¦ãƒ¼ã‚¶ç™»éŒ²</h3>
            <form @submit.prevent="createUser">
                <div class="ts-form-group">
                    <label>åå‰</label>
                    <input type="text" v-model="newUser.full_name" required>
                </div>
                <div class="ts-form-group">
                    <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" v-model="newUser.email" required>
                </div>
                <div class="ts-form-group">
                    <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" v-model="newUser.password" required>
                </div>
                <div class="ts-form-group">
                    <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
                    <input type="password" v-model="newUser.password2" required>
                </div>
                <div class="ts-form-group">
                    <label>å­¦ç±ç•ªå·</label>
                    <input type="text" v-model="newUser.student_id" maxlength="4" required>
                </div>
                <div class="ts-form-group">
                    <label>å®Ÿé¨“æ›œæ—¥</label>
                    <select v-model="newUser.experiment_day">
                        <option value="ç«">ç«</option>
                        <option value="æœ¨">æœ¨</option>
                    </select>
                </div>
                <div class="ts-form-group">
                    <label>å®Ÿé¨“ç­</label>
                    {% verbatim %}
                    <select v-model="newUser.experiment_group">
                        <option v-for="n in 20" :key="n" :value="String(n).padStart(2, '0')">
                            {{ String(n).padStart(2, '0') }}
                        </option>
                    </select>
                    {% endverbatim %}
                </div>
                <div class="ts-modal-actions mt-3">
                    <button type="submit" class="ts-create-btn">ç™»éŒ²</button>
                    <button type="button" class="ts-cancel-btn" @click="showModal = false">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="table-responsive">
        <table class="ts-table">
            <thead>
                <tr>
                    <th>åå‰</th>
                    <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                    <th>ãƒ­ãƒ¼ãƒ«</th>
                    <th>ã‚°ãƒ«ãƒ¼ãƒ—</th>
                    <th>æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
            {% verbatim %}
                <tr v-for="user in users" :key="user.id">
                    <td>{{ user.name }}</td>
                    <td>{{ user.email }}</td>
                    <!-- ãƒ­ãƒ¼ãƒ«ç·¨é›† -->
                    <td>
                        <span v-if="!user.editingRole">
                            {{ user.role }}
                            <button class="ts-edit-btn" @click="enableEdit(user, 'role')">âœï¸</button>
                        </span>
                        <span v-else>
                            <select :id="'roles-' + user.id" multiple style="width: 120px;">
                                <option value="student">student</option>
                                <option value="teacher">teacher</option>
                                <option value="admin">admin</option>
                            </select>
                            <button class="ts-save-btn" @click="saveRole(user)">ğŸ’¾</button>
                            <button class="ts-cancel-edit-btn" @click="cancelEdit(user, 'role')">âœ•</button>
                        </span>
                    </td>
                    <!-- ã‚°ãƒ«ãƒ¼ãƒ—ç·¨é›† -->
                    <td>
                        <span v-if="!user.editingGroup">
                            {{ user.group }}
                            <button class="ts-edit-btn" @click="enableEdit(user, 'group')">âœï¸</button>
                        </span>
                        <span v-else>
                            <select :id="'groups-' + user.id" style="width: 100px;">
                                <option v-for="option in groupOptions" :value="option" v-text="option"></option>
                            </select>
                            <button class="ts-save-btn" @click="saveGroup(user)">ğŸ’¾</button>
                            <button class="ts-cancel-edit-btn" @click="cancelEdit(user, 'group')">âœ•</button>
                        </span>
                    </td>
                    <td>{{ user.last_login }}</td>
                    <td>
                        <button class="ts-delete-btn" @click="deleteUser(user)">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            {% endverbatim %}
            </tbody>
        </table>
    </div>
</div>
<script>
    var USERS_DATA = {{ users_json|safe }};
    var CSRF_TOKEN = '{{ csrf_token }}';
</script>
  <!-- 1. Vueæœ¬ä½“ã‚’å…ˆã« -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <!-- 2. jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- 3. Select2ã®CSSã¨JS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
  <!-- 4. è‡ªä½œJS -->
  <script src="{% static 'submission/js/user_table.js' %}"></script>
{% endblock %}
