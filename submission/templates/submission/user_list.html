{% extends "base.html" %}
{% load static %}

{% block title %}„É¶„Éº„Ç∂‰∏ÄË¶ß{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="{% static 'submission/css/user_table.css' %}">
{% endblock %}

{% block content %}
<div id="user-table" class="p-4">
    <h2>„É¶„Éº„Ç∂‰∏ÄË¶ß</h2>
    <button class="btn btn-primary mb-3" @click="showModal = true">Ôºã Êñ∞Ë¶è„É¶„Éº„Ç∂„ÉºÁôªÈå≤</button>
    <button class="btn btn-secondary mb-3" @click="triggerFileInput">„É¶„Éº„Ç∂‰∏ÄÊã¨ÁôªÈå≤</button>
    <input type="file" ref="csvInput" accept=".csv" @change="uploadCsv" style="display:none">

    <!-- Êñ∞Ë¶è„É¶„Éº„Ç∂„ÉºÁôªÈå≤„É¢„Éº„ÉÄ„É´ -->
    {% verbatim %}
    <div v-if="showModal" class="ts-modal-overlay">
        <div class="ts-modal">
            <h3>Êñ∞Ë¶è„É¶„Éº„Ç∂ÁôªÈå≤</h3>
            <form @submit.prevent="createUser">
                <div class="ts-form-group">
                    <label>ÂêçÂâç</label>
                    <input type="text" v-model="newUser.full_name" required>
                </div>
                <div class="ts-form-group">
                    <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                    <input type="email" v-model="newUser.email" required>
                </div>
                <div class="ts-form-group">
                    <label>„Éë„Çπ„ÉØ„Éº„Éâ</label>
                    <input type="password" v-model="newUser.password" required>
                </div>
                <div class="ts-form-group">
                    <label>„Éë„Çπ„ÉØ„Éº„ÉâÔºàÁ¢∫Ë™çÔºâ</label>
                    <input type="password" v-model="newUser.password2" required>
                </div>
                <div class="ts-form-group">
                    <label>Â≠¶Á±çÁï™Âè∑</label>
                    <input type="text" v-model="newUser.student_id" maxlength="4" required>
                </div>
                <div class="ts-form-group">
                    <label>ÂÆüÈ®ìÊõúÊó•</label>
                    <select v-model="newUser.experiment_day">
                        <option value="ÁÅ´">ÁÅ´</option>
                        <option value="Êú®">Êú®</option>
                    </select>
                </div>
                <div class="ts-form-group">
                    <label>ÂÆüÈ®ìÁè≠</label>
                    <select v-model="newUser.experiment_group">
                        <option v-for="n in 20" :key="n" :value="('0' + n).slice(-2)">
                            {{ ('0' + n).slice(-2) }}
                        </option>
                    </select>
                </div>
                <div class="ts-modal-actions mt-3">
                    <button type="submit" class="ts-create-btn">ÁôªÈå≤</button>
                    <button type="button" class="ts-cancel-btn" @click="showModal = false">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            </form>
        </div>
    </div>
    {% endverbatim %}

    <!-- „É¶„Éº„Ç∂‰∏ÄË¶ß„ÉÜ„Éº„Éñ„É´ -->
    <div class="table-responsive">
        <table class="ts-table">
            <thead>
                <tr>
                    <th>ÂêçÂâç</th>
                    <th>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</th>
                    <th @click="toggleSort('student_id')" style="cursor:pointer">Â≠¶ÁîüÁï™Âè∑</th>
                    <th>„É≠„Éº„É´
                        <div>
                            <select v-model="filters.role" class="form-select form-select-sm">
                                <option value="">ÂÖ®„Å¶</option>
                                <option value="student">student</option>
                                <option value="teacher">teacher</option>
                                <option value="non-editing teacher">non-editing teacher</option>
                                <option value="admin">admin</option>
                            </select>
                        </div>
                    </th>
                    <th>„Ç∞„É´„Éº„Éó
                        <div>
                            <select v-model="filters.group" class="form-select form-select-sm">
                                <option value="">ÂÖ®„Å¶</option>
                                <option v-for="option in groupOptions" :value="option" v-text="option"></option>
                            </select>
                        </div>
                    </th>
                    <th>Âá∫Â∏≠Èñ≤Ë¶ß</th>
                    <th>ÊúÄÁµÇ„Ç¢„ÇØ„Çª„Çπ</th>
                    <th>Êìç‰Ωú</th>
                </tr>
            </thead>
            <tbody>
            {% verbatim %}
                <tr v-for="user in processedUsers" :key="user.id">
                    <td>{{ user.name }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.student_id }}</td>
                    <!-- „É≠„Éº„É´Á∑®ÈõÜ -->
                    <td>
                        <span v-if="!user.editingRole">
                            {{ user.role }}
                            <button class="ts-edit-btn" @click="enableEdit(user, 'role')">‚úèÔ∏è</button>
                        </span>
                        <span v-else>
                            <select :id="'roles-' + user.id" style="width: 120px;">
                                <option value="student">student</option>
                                <option value="teacher">teacher</option>
                                <option value="non-editing teacher">non-editing teacher</option>
                                <option value="admin">admin</option>
                            </select>
                            <button class="ts-save-btn" @click="saveRole(user)">üíæ</button>
                            <button class="ts-cancel-edit-btn" @click="cancelEdit(user, 'role')">‚úï</button>
                        </span>
                    </td>
                    <!-- „Ç∞„É´„Éº„ÉóÁ∑®ÈõÜ -->
                    <td>
                        <span v-if="!user.editingGroup">
                            {{ user.group }}
                            <button class="ts-edit-btn" @click="enableEdit(user, 'group')">‚úèÔ∏è</button>
                        </span>
                        <span v-else>
                            <select :id="'groups-' + user.id" style="width: 100px;">
                                <option v-for="option in groupOptions" :value="option" v-text="option"></option>
                            </select>
                            <button class="ts-save-btn" @click="saveGroup(user)">üíæ</button>
                            <button class="ts-cancel-edit-btn" @click="cancelEdit(user, 'group')">‚úï</button>
                        </span>
                    </td>
                    <td>
                        <input type="checkbox" v-model="user.can_view_attendance" @change="toggleAttendance(user)">
                    </td>
                    <td>{{ user.last_login }}</td>
                    <td>
                        <button class="ts-delete-btn" @click="deleteUser(user)">üóëÔ∏è</button>
                    </td>
                </tr>
            {% endverbatim %}
            </tbody>
        </table>
    </div>
</div>
<script>
    var USERS_DATA = {{ users_json|safe }};
    var CSRF_TOKEN = '{{ csrf_token }}';
</script>
<!-- Vue, jQuery, Select2, Ëá™‰ΩúJS„ÅÆÈ†Ü -->
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
<script src="{% static 'submission/js/user_table.js' %}"></script>
{% endblock %}
